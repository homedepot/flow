language: python
dist: trusty
sudo: false
cache: pip

branches:
  only:
  - travis

if: tag IS blank

jobs:
  include:
    - stage: version
      install:
        - pip install -e .
      python: "3.5"
      script: flow github version production
    - stage: unit test
      install:
        - pip install -e .
      python: "3.5"
      script: py.test -s -v ./tests --capture=sys
    - stage: quality
      install:
        - pip install coveralls
        - pip install bandit
        - pip install -e .
      python: "3.5"
      script: coverage run --source flow -m py.test
      after_success:
        - coverage report
        - coveralls
      script: bandit -r -ll -ii -x tests .
      script: flow tracker label-release production
    - stage: pypi
      python: "3.5"
      script: skip
      deploy:
        provider: pypi
        user: $PYPI_USER
        password: $PYPI_PWD
        skip_cleanup: true
        on:
          branch: master
    - stage: docker
      install:
        - pip install -e .
      python: "3.5"
      script:
        - flow github -o VERSION getversion production
        - docker build -t aturner/flow .
      after_success:
        - docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD";
        - docker push aturner/flow;